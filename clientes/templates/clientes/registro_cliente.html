<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Cliente</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            margin-top: 30px;
        }
        .btn-buscar {
            padding: 0.375rem 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0"><i class="bi bi-person-plus-fill"></i> Registro Cliente</h3>
                    </div>
                    <div class="card-body">
                        <!-- Mensajes de √©xito o error -->
                        {% if messages %}
                            {% for message in messages %}
                                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}

                        <form method="post" id="clienteForm">
                            {% csrf_token %}
                            
                            <!-- C√≥digo Cliente con bot√≥n de b√∫squeda -->
                            <div class="row mb-3">
                                <label for="id_codCliente" class="col-sm-3 col-form-label fw-bold">
                                    C√≥digo Cliente:
                                </label>
                                <div class="col-sm-7">
                                    {{ form.codCliente }}
                                </div>
                                <div class="col-sm-2">
                                    <button type="button" class="btn btn-secondary btn-buscar w-100" id="btnBuscar" title="Buscar cliente">
                                        üîç
                                    </button>
                                </div>
                            </div>

                            <!-- Nombre -->
                            <div class="row mb-3">
                                <label for="id_nomCliente" class="col-sm-3 col-form-label fw-bold">
                                    Nombre:
                                </label>
                                <div class="col-sm-9">
                                    {{ form.nomCliente }}
                                </div>
                            </div>

                            <!-- Apellido -->
                            <div class="row mb-3">
                                <label for="id_apellCliente" class="col-sm-3 col-form-label fw-bold">
                                    Apellido:
                                </label>
                                <div class="col-sm-9">
                                    {{ form.apellCliente }}
                                </div>
                            </div>

                            <!-- Tipo Documento -->
                            <div class="row mb-3">
                                <label for="id_idTipoDoc" class="col-sm-3 col-form-label fw-bold">
                                    Tipo Documento:
                                </label>
                                <div class="col-sm-9">
                                    {{ form.idTipoDoc }}
                                </div>
                            </div>

                            <!-- N√∫mero Documento -->
                            <div class="row mb-3">
                                <label for="id_nDocumento" class="col-sm-3 col-form-label fw-bold">
                                    N√∫mero Documento:
                                </label>
                                <div class="col-sm-9">
                                    {{ form.nDocumento }}
                                </div>
                            </div>

                            <!-- Botones -->
                            <div class="row mt-4">
                                <div class="col-sm-12 text-center">
                                    <button type="submit" class="btn btn-success btn-lg px-4">
                                        <i class="bi bi-save"></i> Guardar
                                    </button>
                                    <button type="button" class="btn btn-danger btn-lg px-4 ms-2" id="btnEliminar" style="display: none;">
                                        <i class="bi bi-trash"></i> Eliminar
                                    </button>
                                    <button type="button" class="btn btn-warning btn-lg px-4 ms-2" id="btnLimpiar">
                                        <i class="bi bi-x-circle"></i> Limpiar
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Funci√≥n para buscar cliente
        document.getElementById('btnBuscar').addEventListener('click', function() {
            const codigo = document.getElementById('id_codCliente').value.trim();
            
            if (!codigo) {
                alert('Por favor ingrese un c√≥digo de cliente');
                return;
            }

            // Mostrar loading
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

            fetch(`/clientes/buscar/?codigo=${encodeURIComponent(codigo)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.existe) {
                        // Llenar los campos con los datos del cliente
                        document.getElementById('id_nomCliente').value = data.nomCliente;
                        document.getElementById('id_apellCliente').value = data.apellCliente;
                        document.getElementById('id_idTipoDoc').value = data.idTipoDoc;
                        document.getElementById('id_nDocumento').value = data.nDocumento;
                        
                        // Hacer el c√≥digo de solo lectura para evitar cambios accidentales
                        document.getElementById('id_codCliente').readOnly = true;
                        document.getElementById('id_codCliente').style.backgroundColor = '#e9ecef';
                        
                        // Mostrar bot√≥n de eliminar
                        document.getElementById('btnEliminar').style.display = 'inline-block';
                        
                        // Mostrar mensaje de √©xito
                        showAlert('‚úì Cliente encontrado. Puede modificar los datos y guardar para actualizar, o eliminarlo.', 'success');
                    } else {
                        // Limpiar campos si no existe
                        document.getElementById('id_nomCliente').value = '';
                        document.getElementById('id_apellCliente').value = '';
                        document.getElementById('id_nDocumento').value = '';
                        
                        // Asegurarse de que el c√≥digo sea editable
                        document.getElementById('id_codCliente').readOnly = false;
                        document.getElementById('id_codCliente').style.backgroundColor = '';
                        
                        // Ocultar bot√≥n de eliminar
                        document.getElementById('btnEliminar').style.display = 'none';
                        
                        showAlert(data.mensaje || 'Cliente no encontrado. Puede crear un nuevo registro con este c√≥digo.', 'info');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Error al buscar cliente. Por favor intente nuevamente.', 'danger');
                })
                .finally(() => {
                    // Restaurar bot√≥n
                    this.disabled = false;
                    this.innerHTML = 'üîç';
                });
        });

        // Funci√≥n para limpiar el formulario
        document.getElementById('btnLimpiar').addEventListener('click', function(e) {
            e.preventDefault(); // Prevenir el comportamiento por defecto
            
            // Limpiar todos los campos del formulario
            document.getElementById('id_codCliente').value = '';
            document.getElementById('id_nomCliente').value = '';
            document.getElementById('id_apellCliente').value = '';
            document.getElementById('id_nDocumento').value = '';
            
            // Resetear el select de tipo de documento al primer valor (vac√≠o)
            const tipoDocSelect = document.getElementById('id_idTipoDoc');
            tipoDocSelect.selectedIndex = 0;
            
            // Quitar readonly del c√≥digo si estaba puesto
            document.getElementById('id_codCliente').readOnly = false;
            document.getElementById('id_codCliente').style.backgroundColor = '';
            
            // Ocultar bot√≥n de eliminar
            document.getElementById('btnEliminar').style.display = 'none';
            
            // Remover cualquier clase de validaci√≥n
            const inputs = document.querySelectorAll('.form-control, .form-select');
            inputs.forEach(input => {
                input.classList.remove('is-invalid', 'is-valid');
            });
            
            // Opcional: Mostrar mensaje de confirmaci√≥n
            showAlert('‚úì Formulario limpiado', 'info');
            
            // Enfocar el primer campo
            document.getElementById('id_codCliente').focus();
        });

        // Funci√≥n para mostrar alertas
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.role = 'alert';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const form = document.getElementById('clienteForm');
            form.parentNode.insertBefore(alertDiv, form);
            
            // Auto-cerrar despu√©s de 5 segundos
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Funci√≥n para eliminar cliente
        document.getElementById('btnEliminar').addEventListener('click', function() {
            const codigo = document.getElementById('id_codCliente').value.trim();
            
            if (!codigo) {
                showAlert('No hay cliente seleccionado para eliminar', 'warning');
                return;
            }

            // Confirmar eliminaci√≥n
            const nombre = document.getElementById('id_nomCliente').value;
            const apellido = document.getElementById('id_apellCliente').value;
            const confirmacion = confirm(`¬øEst√° seguro de eliminar al cliente "${codigo}" - ${nombre} ${apellido}?\n\nEsta acci√≥n no se puede deshacer.`);
            
            if (!confirmacion) {
                return;
            }

            // Deshabilitar bot√≥n y mostrar loading
            this.disabled = true;
            const textoOriginal = this.innerHTML;
            this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Eliminando...';

            // Obtener token CSRF
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // Realizar petici√≥n de eliminaci√≥n
            fetch('/clientes/eliminar/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrftoken
                },
                body: `codigo=${encodeURIComponent(codigo)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(`‚úì ${data.mensaje}`, 'success');
                    
                    // Limpiar el formulario despu√©s de eliminar
                    document.getElementById('btnLimpiar').click();
                } else {
                    showAlert(`‚ùå Error: ${data.error}`, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Error al eliminar el cliente. Por favor intente nuevamente.', 'danger');
            })
            .finally(() => {
                // Restaurar bot√≥n
                this.disabled = false;
                this.innerHTML = textoOriginal;
            });
        });

        // Permitir buscar con Enter en el campo de c√≥digo
        document.getElementById('id_codCliente').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('btnBuscar').click();
            }
        });
    </script>
</body>
</html>
