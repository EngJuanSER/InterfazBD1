<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Cliente - Sistema de Abogados</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            margin-top: 30px;
        }
        .btn-buscar {
            padding: 0.375rem 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0"><i class="bi bi-person-plus-fill"></i> Registro de Cliente</h3>
                    </div>
                    <div class="card-body">
                        <!-- Mensajes de √©xito o error -->
                        {% if messages %}
                            {% for message in messages %}
                                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}

                        <form method="post" id="clienteForm">
                            {% csrf_token %}
                            
                            <!-- Campo oculto para el ID del cliente (usado en actualizaciones) -->
                            <input type="hidden" name="cliente_id" id="hidden_cliente_id" value="">
                            
                            <!-- ID Cliente con bot√≥n de b√∫squeda -->
                            <div class="row mb-3">
                                <label for="id_cliente_id" class="col-sm-3 col-form-label fw-bold">
                                    ID Cliente:
                                </label>
                                <div class="col-sm-7">
                                    <input type="number" name="cliente_id" id="id_cliente_id" class="form-control" placeholder="Ingrese ID del cliente para buscar">
                                </div>
                                <div class="col-sm-2">
                                    <button type="button" class="btn btn-secondary btn-buscar w-100" id="btnBuscar" title="Buscar cliente">
                                        üîç
                                    </button>
                                </div>
                            </div>

                            <!-- N√∫mero de Documento -->
                            <div class="row mb-3">
                                <label for="id_n_documento_cliente" class="col-sm-3 col-form-label fw-bold">
                                    <span class="text-danger">*</span> N√∫mero Documento:
                                </label>
                                <div class="col-sm-9">
                                    {{ form.n_documento_cliente }}
                                </div>
                            </div>

                            <!-- Tipo Documento -->
                            <div class="row mb-3">
                                <label for="id_id_tipo_doc" class="col-sm-3 col-form-label fw-bold">
                                    <span class="text-danger">*</span> Tipo Documento:
                                </label>
                                <div class="col-sm-9">
                                    {{ form.id_tipo_doc }}
                                </div>
                            </div>

                            <!-- Nombre -->
                            <div class="row mb-3">
                                <label for="id_nombre_cliente" class="col-sm-3 col-form-label fw-bold">
                                    <span class="text-danger">*</span> Nombre:
                                </label>
                                <div class="col-sm-9">
                                    {{ form.nombre_cliente }}
                                </div>
                            </div>

                            <!-- Apellido -->
                            <div class="row mb-3">
                                <label for="id_apellido_cliente" class="col-sm-3 col-form-label fw-bold">
                                    <span class="text-danger">*</span> Apellido:
                                </label>
                                <div class="col-sm-9">
                                    {{ form.apellido_cliente }}
                                </div>
                            </div>

                            <!-- Direcci√≥n de Notificaci√≥n -->
                            <div class="row mb-3">
                                <label for="id_direccion_notificacion" class="col-sm-3 col-form-label fw-bold">
                                    Direcci√≥n:
                                </label>
                                <div class="col-sm-9">
                                    {{ form.direccion_notificacion }}
                                </div>
                            </div>

                            <!-- Fecha de Nacimiento -->
                            <div class="row mb-3">
                                <label for="id_fecha_nacimiento" class="col-sm-3 col-form-label fw-bold">
                                    Fecha Nacimiento:
                                </label>
                                <div class="col-sm-9">
                                    {{ form.fecha_nacimiento }}
                                </div>
                            </div>

                            <!-- Observaciones -->
                            <div class="row mb-3">
                                <label for="id_observaciones" class="col-sm-3 col-form-label fw-bold">
                                    Observaciones:
                                </label>
                                <div class="col-sm-9">
                                    {{ form.observaciones }}
                                </div>
                            </div>

                            <!-- Botones -->
                            <div class="row mt-4">
                                <div class="col-sm-12 text-center">
                                    <button type="submit" class="btn btn-success btn-lg px-4">
                                        <i class="bi bi-save"></i> Guardar
                                    </button>
                                    <button type="button" class="btn btn-danger btn-lg px-4 ms-2" id="btnEliminar" style="display: none;">
                                        <i class="bi bi-trash"></i> Eliminar
                                    </button>
                                    <button type="button" class="btn btn-warning btn-lg px-4 ms-2" id="btnLimpiar">
                                        <i class="bi bi-x-circle"></i> Limpiar
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Funci√≥n para buscar cliente por ID
        document.getElementById('btnBuscar').addEventListener('click', function() {
            const clienteId = document.getElementById('id_cliente_id').value.trim();
            
            if (!clienteId) {
                alert('Por favor ingrese un ID de cliente');
                return;
            }

            // Mostrar loading
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

            fetch(`/clientes/buscar/?id=${encodeURIComponent(clienteId)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.existe) {
                        // Establecer el ID en el campo oculto para actualizaci√≥n
                        document.getElementById('hidden_cliente_id').value = data.cliente_id;
                        
                        // Llenar los campos con los datos del cliente
                        document.getElementById('id_nombre_cliente').value = data.nombre_cliente;
                        document.getElementById('id_apellido_cliente').value = data.apellido_cliente;
                        document.getElementById('id_id_tipo_doc').value = data.id_tipo_doc;
                        document.getElementById('id_n_documento_cliente').value = data.n_documento_cliente;
                        document.getElementById('id_direccion_notificacion').value = data.direccion_notificacion;
                        document.getElementById('id_fecha_nacimiento').value = data.fecha_nacimiento;
                        document.getElementById('id_observaciones').value = data.observaciones;
                        
                        // Bloquear el campo ID para evitar cambios accidentales
                        // Para editar otro cliente, debe usar "Limpiar" primero
                        document.getElementById('id_cliente_id').readOnly = true;
                        document.getElementById('id_cliente_id').style.backgroundColor = '#d1f4d1';
                        document.getElementById('id_cliente_id').style.cursor = 'not-allowed';
                        
                        // Mostrar bot√≥n de eliminar
                        document.getElementById('btnEliminar').style.display = 'inline-block';
                        
                        // Mostrar mensaje de √©xito
                        showAlert('‚úì Cliente encontrado. Puede modificar los datos y guardar. Para buscar otro cliente use "Limpiar" primero.', 'success');
                    } else {
                        // Limpiar campos si no existe
                        document.getElementById('id_nombre_cliente').value = '';
                        document.getElementById('id_apellido_cliente').value = '';
                        document.getElementById('id_n_documento_cliente').value = '';
                        document.getElementById('id_direccion_notificacion').value = '';
                        document.getElementById('id_fecha_nacimiento').value = '';
                        document.getElementById('id_observaciones').value = '';
                        
                        // Asegurarse de que el ID sea editable
                        document.getElementById('id_cliente_id').readOnly = false;
                        document.getElementById('id_cliente_id').style.backgroundColor = '';
                        
                        // Ocultar bot√≥n de eliminar
                        document.getElementById('btnEliminar').style.display = 'none';
                        
                        showAlert(data.mensaje || 'Cliente no encontrado con ese ID.', 'info');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Error al buscar cliente. Por favor intente nuevamente.', 'danger');
                })
                .finally(() => {
                    // Restaurar bot√≥n
                    this.disabled = false;
                    this.innerHTML = 'üîç';
                });
        });

        // Funci√≥n para limpiar el formulario
        document.getElementById('btnLimpiar').addEventListener('click', function(e) {
            e.preventDefault();
            
            // Limpiar todos los campos del formulario
            document.getElementById('hidden_cliente_id').value = '';
            document.getElementById('id_cliente_id').value = '';
            document.getElementById('id_n_documento_cliente').value = '';
            document.getElementById('id_nombre_cliente').value = '';
            document.getElementById('id_apellido_cliente').value = '';
            document.getElementById('id_direccion_notificacion').value = '';
            document.getElementById('id_fecha_nacimiento').value = '';
            document.getElementById('id_observaciones').value = '';
            
            // Resetear el select de tipo de documento al primer valor
            const tipoDocSelect = document.getElementById('id_id_tipo_doc');
            tipoDocSelect.selectedIndex = 0;
            
            // Desbloquear el campo ID completamente
            const idField = document.getElementById('id_cliente_id');
            idField.readOnly = false;
            idField.style.backgroundColor = '';
            idField.style.cursor = '';
            
            // Ocultar bot√≥n de eliminar
            document.getElementById('btnEliminar').style.display = 'none';
            
            // Remover cualquier clase de validaci√≥n
            const inputs = document.querySelectorAll('.form-control, .form-select');
            inputs.forEach(input => {
                input.classList.remove('is-invalid', 'is-valid');
            });
            
            showAlert('‚úì Formulario limpiado', 'info');
            
            // Enfocar el primer campo
            document.getElementById('id_cliente_id').focus();
        });

        // Funci√≥n para mostrar alertas
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.role = 'alert';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const form = document.getElementById('clienteForm');
            form.parentNode.insertBefore(alertDiv, form);
            
            // Auto-cerrar despu√©s de 5 segundos
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Funci√≥n para eliminar cliente
        document.getElementById('btnEliminar').addEventListener('click', function() {
            const clienteId = document.getElementById('id_cliente_id').value.trim();
            
            if (!clienteId) {
                showAlert('No hay cliente seleccionado para eliminar', 'warning');
                return;
            }

            // Confirmar eliminaci√≥n
            const nombre = document.getElementById('id_nombre_cliente').value;
            const apellido = document.getElementById('id_apellido_cliente').value;
            const confirmacion = confirm(`¬øEst√° seguro de eliminar al cliente "${nombre} ${apellido}" (ID: ${clienteId})?\n\nEsta acci√≥n no se puede deshacer.`);
            
            if (!confirmacion) {
                return;
            }

            // Deshabilitar bot√≥n y mostrar loading
            this.disabled = true;
            const textoOriginal = this.innerHTML;
            this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Eliminando...';

            // Obtener token CSRF
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // Realizar petici√≥n de eliminaci√≥n
            fetch('/clientes/eliminar/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrftoken
                },
                body: `id=${encodeURIComponent(clienteId)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(`‚úì ${data.mensaje}`, 'success');
                    
                    // Limpiar el formulario despu√©s de eliminar
                    document.getElementById('btnLimpiar').click();
                } else {
                    showAlert(`‚ùå Error: ${data.error}`, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Error al eliminar el cliente. Por favor intente nuevamente.', 'danger');
            })
            .finally(() => {
                // Restaurar bot√≥n
                this.disabled = false;
                this.innerHTML = textoOriginal;
            });
        });

        // Permitir buscar con Enter en el campo de ID
        document.getElementById('id_cliente_id').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('btnBuscar').click();
            }
        });
    </script>
</body>
</html>
